## 7. &nbsp; Data Visualization Apps

<link rel="stylesheet" href="css/style.css">

Matlab functions for visualizing data:

* `gui_Browse_Folder`: given a filepath, this function will open a new figure window and provide a dropdown containing all traces located at that filepath location. You can pick one or scroll through using the arrow buttons.\
* `guiPlotTraces`\
* `plotApp`.

**Note**: there is also an R Shiny App (see below)
<br>

### Plotting data using `plotApp` function

`plotApp` is a Matlab graphical user interface (GUI) made to facilitate visualization of database traces as:\
(i) Basic time series;\
(ii) Statistical summary;\
(iii) Comparison amongst traces; and\
(iv) Comparisons amongst stages.

#### Quick Start `plotApp` Instructions:

* In Matlab, run `plotApp` on the command line (figure 7.1).

    <img src="images/visualization/CommandLine.jpg" alt="plotApp:CommandLine" width="250"/>

    *Figure 7.1. How to launch the plotApp GUI in Matlab.*

* The GUI in figure 7.2 will launch; specify the folder containing the database you would like to plot by typing the folder path or by clicking the folder button and navigating to the desired folder.

    * You need to specify the `\Database\` folder (immediately beneath your project folder) rather than the individual year or site folder. 
    * The *Year* and *Site* will be chosen from the drop-down menus which are automatically populated based on what is available in the folder.
    * If you type in the folder path manually or paste it into the Folder field, press 'Enter' when complete.
    * On subsequent uses of plotApp, it will remember the last Folder that was entered.

    <img src="images/visualization/plotApp1.jpg" alt="plotApp:GUI1" width="500"/>

    *Figure 7.2. plotApp GUI showing where to enter the Database folder to view and analyze data.*

* Next, select the *Year*, *Site*, and *Data type* (Flux, Met, Clean, etc.) that you want to plot.
* *Flux* and *Met* data type are associated with *Raw* and *Stage1* traces. *Clean* data type is associated with *Stage2* and higher.
* Once these selections are made, the 'Traces' list will populate; then click on a trace to select it and plot the time series (figure 7.3).

    <img src="images/visualization/plotApp2.jpg" alt="plotApp:GUI2" width="500"/>

    *Figure 7.3. Example of plotApp GUI showing time series plotted after selecting data.*

* You can use the Matlab window navigation tools (i.e., zoom, pan, data tips) to explore the traces.
* Two traces can be plotted at once for quick and easy reference, or for qualitative visual comparisons.

#### Trace Analysis

The Trace analysis drop-down menu has four options:\
(i) Single trace;\
(ii) Plot parents;\
(iii) Compare traces; and\
(iv) Compare Stages (coming soon...).

* Options (i), (ii), and (iv) operate on a single trace, which is defined by the 'Trace' selector <img src="images/visualization/TraceButton.jpg" width="75"> (i.e., 1 or 2, upper or lower panel, respectively). 
* Option (iv) compares the selected trace with its previous stage.
* Options (iii) operates on both Trace 1 and 2.

*Single Trace*

A basic summary of a single trace can be plotted using the *Trace analysis* drop-down menu.

* For the single trace summary, first select Trace '1' (upper panel) or '2' (lower panel) using the up/down buttons.
* From the *Trace analysis* drop-down menu, select 'Single trace'.
* A new window will open with the trace summary (figure 7.4).

    <img src="images/visualization/plotAppFig1.jpg" alt="plotApp:Fig1" width="500"/>

    *Figure 7.4. Example of single-trace summary in plotApp GUI.*

The four panel ’Single trace’ summary includes (i) upper left – raw half-hourly data and daily average; (ii)  upper right – diurnal trend using boxplots on an hourly basis; (iii) lower left – Q-Q plot; and (iv) lower right – cumulative distribution with 1st and 99th percentile, mean, and median printed.

* Panels (ii)–(iv) are a summary of the raw data in panel (i).
* Users can interact with panel (i) using the Matlab navigation tools (zoom and pan only) to analyze a subset of the data.
* After zooming/panning, panels (ii)–(iv) will automatically update.
* To restore the view to the whole data set, with zoom out selected, double-click panel (i). Alternately, right click on panel (i) and select 'Restore view' from the drop-down.

*Compare traces*

A basic comparison of Trace '1' and '2' can be plotted using the *Trace analysis* drop-down menu and selecting 'Compare traces'.

* A new window will open with the trace comparison (figure 7.5).
* Any two traces can be compared. There are no restrictions on *Site*, *Data* type or *Level*, but currently the *Year* must be the same for each trace.
* An error message will appear if only one trace is plotted or if Year doesn’t match.

    <img src="images/visualization/plotAppFig2.jpg" alt="plotApp:Fig2" width="500"/>

    *Figure 7.5. Example of 'Compare trace' summary in plotApp GUI.*


The four panel 'Plot comparison' summary includes (i) upper left – raw half-hourly residuals and their daily average; (ii)  upper right – normalized cross-covariance for +/- 48 measurement intervals; (iii) scatter plot comparing the two traces; and (iv) lower right – cumulative distribution of the residuals.

* As for the single-trace analysis, users can interact with panel (i) using the Matlab navigation tools (zoom and pan only) to analyze a subset of the data.
* After zooming/panning, panels (ii)–(iv) will automatically update.
* To restore the view to the whole data set, with zoom out selected, double-click panel (i). Alternately, right click on panel (i) and select 'Restore view' from the drop-down.
* Panel (ii) displays the lag with the highest cross-covariance between the two traces for data visible in panel (i).
* Panel (iii) displays the slope and intercept of the linear regression between the two traces, along with the r<sup>2</sup> value for data visible in panel (i).
* Panel (iv) displays the root mean squared error (RMSE), mean absolute deviation (MAD), mean, and median of the residuals in panel (i).

*Plot parents*

* The *Trace analysis* option is meant to aid the assessment of data cleaning amongst stages. For example, if more data is removed due to data cleaning than expected, *Plot parents* can be used to help identify which parent trace resulted in data removal.
* The 'Trace' selector (i.e., 1 or 2)  defines which trace will be analyzed and displays the analysis in a new window (figure 7.6).

    <img src="images/visualization/plotAppParents.jpg" alt="plotApp:parents" width="600"/>

    *Figure 7.6. Example of 'plot parents' display in plotApp GUI.*

* For a particular stage, 'Plot parents' shows the data from the current stage (orange circles, upper panel) and contrasts with the previous stage (i.e. blue circles, upper panel).
* The minMax=[] bounds for the trace defined in the .ini file for the particular site are shown in the upper panel in yellow and purple.
* The lower panel shows all the parents of a particular trace (i.e., those traces which include that trace as a dependent=’’ in the INI file). Note, dependents are often called using 'tags'.
* In the lower panel, 0 - SELF refers to data which are missing before cleaning based on dependents. 
* For all other parents, a large dot indicates a point which was removed from the selected trace which was not missing in the previous stage. A small dot indicates the data from the selected trace would be removed based on the parent, but was already missing from the previous stage.
* Users can interact with the figure using the Matlab navigation tools (e.g., zoom and pan) to view a subset of the data. 
    * It is recommended that you only zoom/pan the top panel.
    * The x-axis of the top and bottom panels are linked, so navigating in one panel will automatically update the x-axis on the corresponding panel.

*Compare traces*

This option in *Trace analysis* is intended to quickly assess what changes occurred between stages for a particular trace.


<br>


### Plotting data using R Shiny app

Instructions for using the `RShiny_flux_plots.R` app (under `./Biomet.net/R/RShiny_flux_plots`)

To run the R Shiny App, either locally or on an RShiny server, you will need to download, edit, rename and save two files.

1. Download the `Excel sheet` below to input your site coordinates (you can include multiple sites, each as a separate line). 

<a href="ini_templates_sample_data/site_coordinates_TUT.xlsx">Example site coordinate file</a>

* **Note** that the standard meridian is equal to your UTC offset (without daylight savings) x 15 (e.g., Vancouver is UTC-8 so the standard meridian is -120)

* Also, latitude and longitude are in decimal degrees and negative for West and South coordinates

2. Now save the excel file under `Calculation_Procedures/SITE/` (i.e., where your other site-specific ini files are). You should rename the file to include your specific `Project Name`.

3.	Download the example `ini file`.

<a href="ini_templates_sample_data/TUT_RShiny_ini.R.zip">Example R Shiny ini file</a>

4. Edit the ini file and rename the paths to match your local computer

5. Select which level(s) you would like to plot (e.g., You can plot `ThirdStage` data by specifying `level <- "Clean/ThirdStage"`, or multiple levels of data using the concatenate command like `level <- c("Clean/ThirdStage","Met")`. 

6. Rename the file to include your specific `Project Name` and save it in under `Calculation_Procedures/SITE/` (i.e., where your other site-specific ini files are).

7. Now you can run the R Shiny App by editing the paths in the code below and running it in the R console (**make sure to change the paths name to match your computer**)

<pre>
source("/Users/saraknox/Code/local_data_cleaning/Projects/EcoFlux/Database/Calculation_Procedures/RShiny_flux_plots_ini/UQAM_ini.R")

source("/Users/saraknox/Code/Biomet.net/R/RShiny_flux_plots/load_save_data.R")
    
shiny::runApp("/Users/saraknox/Code/Biomet.net/R/RShiny_flux_plots/RShiny_flux_plots.R") 
</pre> 

**Note**: if you get an error installing the package `imager`, you may need to try: 

For `imager`, you may need to download quartz to be able to run this library properly (https://www.xquartz.org) & then use `install.packages("igraph", type="binary")`


<!-- 1. Create a visualization INI file for your site (see examples in the `Biomet.net` library under `Biomet.net/R/data_visualization_EcoFlux/ini_files/`; not to be confused with data-cleaning INI files). 
[XXX Sara: the examples in here vary a bit, and are a bit long and confusing... can I just use RShiny_flux_plots_ini/EcoFlux_ini.R as a template for the instructions?]

2. Make a new directory in your `Calculation_Procedures` directory called `RShiny_flux_plots_ini`, and put this INI file there. Edit the relevant directory paths in this INI file for your own local computer.

3. You will also need to include an XLSX file with your site coordinates (format shown in figure 7.1), in the same directory as the INI file.

2. In your R console, edit and enter the following (note that you can also create an R script with the code below and run the R script):

    a. `source("/Users/<username>/Code/local_data_cleaning/Projects/EcoFlux/Database/Calculation_Procedures/RShiny_flux_plots_ini/EcoFlux_ini.R")` [XXX does it matter where the INI and xlsx files are stored so long as they are sourced properly here?] no just create plotting INI file in their cal_proc directory

    b.
    `source("/Users/<username>/Biomet.net/R/RShiny_flux_plots/load_save_data.R")`
    
    c. Run 'RShiny_flux_plots.R' and include your local path to the file
    `shiny::runApp("/Users/<username>/Biomet.net/R/RShiny_flux_plots/RShiny_flux_plots.R")` -->
